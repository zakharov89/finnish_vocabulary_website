{% extends "base.html" %}

{% block content %}

<h2>Add New Word</h2>

<div class="admin-add-word-container">
<form method="post" class="admin-add-word-form">

    <!-- Word -->
    <p>
        <input type="text" name="word" required class="admin-input" placeholder="Enter new word">
    </p>

    <!-- Level -->
    <p>
        <label>Level:</label><br>
        <select name="level" class="admin-select">
            {% for level in levels %}
                <option value="{{ level.id }}">{{ level.name }}</option>
            {% endfor %}
        </select>
    </p>

    <!-- Categories (autocomplete + pills) -->
    <h3>Categories</h3>
    <div id="category-selector">
        <input type="text"
               id="category-input"
               class="admin-input"
               placeholder="Start typing a category name..."
               list="category-datalist">

        <datalist id="category-datalist">
            {% for cat in categories %}
                <option value="{{ cat['name'] }}"></option>
            {% endfor %}
        </datalist>

        <div id="selected-categories" class="selected-categories"></div>
    </div>

    <!-- Meanings -->
    <h3>Meanings</h3>
    <div id="meanings-container" class="meanings-section">
        <div class="meaning-block" data-meaning-number="1">

            <input type="hidden" name="meaning_number[]" value="1">

            <!-- Part of Speech -->
            <p>Part of Speech:</p>
            <select name="pos_id_1" required class="admin-select">
                {% for pos in pos_list %}
                    <option value="{{ pos['id'] }}">{{ pos['name'] }}</option>
                {% endfor %}
            </select>

            <p>Translations:</p>
            <div id="translations-1" class="translations-group">
                <input type="text" name="translations_1[]" class="admin-input" placeholder="Enter translation">
            </div>
            <button type="button" class="admin-btn" onclick="addTranslation(1)">+ Add Translation</button>

            <p>Examples (optional):</p>
            <div id="examples-1" class="examples-group">
                <div class="example-pair">
                    <input type="text" name="examples_1[]" class="admin-input" placeholder="Enter example">
                    <input type="text" name="examples_trans_1[]" class="admin-input" placeholder="Enter example translation">
                </div>
            </div>
            <button type="button" class="admin-btn" onclick="addExample(1)">+ Add Example</button>

            <p>Finnish definition (optional):</p>
            <input type="text" name="definition_1" class="admin-input" placeholder="Enter Finnish definition">

            <p>Notes (optional):</p>
            <input type="text" name="meaning_notes_1" class="admin-input" placeholder="Enter notes">

            <button type="button" class="admin-btn-small delete-btn" onclick="deleteMeaning(this)">Delete Meaning</button>
        </div>
    </div>

    <button type="button" onclick="addMeaning()" class="admin-btn">+ Add Meaning</button>

    <p>
        <button type="submit" class="admin-btn">Add Word</button>
    </p>

</form>
</div>

<p>
    <a href="{{ url_for('admin_dashboard') }}" class="admin-btn-small">Back to Dashboard</a>
</p>

<script>
(function(){
    let meaningCount = 1;

    const pos_list = {{ pos_list|tojson }};
    const categoriesData = {{ categories|tojson }};  // [{id: .., name: ..}, ...]

    // -----------------------------------
    // Meanings logic (your existing code)
    // -----------------------------------
    window.addMeaning = function() {
        meaningCount++;
        const container = document.getElementById('meanings-container');

        let posOptions = '';
        pos_list.forEach(pos => {
            posOptions += `<option value="${pos.id}">${pos.name}</option>`;
        });

        const div = document.createElement('div');
        div.className = 'meaning-block';
        div.dataset.meaningNumber = meaningCount;
        div.innerHTML = `
            <input type="hidden" name="meaning_number[]" value="${meaningCount}">

            <p>Part of Speech:</p>
            <select name="pos_id_${meaningCount}" required class="admin-select">
                ${posOptions}
            </select>

            <p>Translations:</p>
            <div id="translations-${meaningCount}" class="translations-group">
                <input type="text" name="translations_${meaningCount}[]" class="admin-input" placeholder="Enter translation">
            </div>
            <button type="button" class="admin-btn" onclick="addTranslation(${meaningCount})">+ Add Translation</button>

            <p>Examples (optional):</p>
            <div id="examples-${meaningCount}" class="examples-group">
                <div class="example-pair">
                    <input type="text" name="examples_${meaningCount}[]" class="admin-input" placeholder="Enter example">
                    <input type="text" name="examples_trans_${meaningCount}[]" class="admin-input" placeholder="Enter example translation">
                </div>
            </div>
            <button type="button" class="admin-btn" onclick="addExample(${meaningCount})">+ Add Example</button>

            <p>Finnish definition (optional):</p>
            <input type="text" name="definition_${meaningCount}" class="admin-input" placeholder="Enter Finnish definition">

            <p>Notes (optional):</p>
            <input type="text" name="meaning_notes_${meaningCount}" class="admin-input" placeholder="Enter notes">

            <button type="button" class="admin-btn-small delete-btn" onclick="deleteMeaning(this)">Delete Meaning</button>
        `;
        container.appendChild(div);
    }

    window.addTranslation = function(num) {
        const container = document.getElementById(`translations-${num}`);
        const input = document.createElement('input');
        input.type = 'text';
        input.name = `translations_${num}[]`;
        input.className = 'admin-input';
        input.placeholder = 'Enter translation';
        container.appendChild(input);
    }

    window.addExample = function(num) {
        const container = document.getElementById(`examples-${num}`);
        const div = document.createElement('div');
        div.className = 'example-pair';
        div.innerHTML = `
            <input type="text" name="examples_${num}[]" class="admin-input" placeholder="Enter example">
            <input type="text" name="examples_trans_${num}[]" class="admin-input" placeholder="Enter example translation">
        `;
        container.appendChild(div);
    }

    window.deleteMeaning = function(button) {
        const meaningBlock = button.closest('.meaning-block');
        meaningBlock.remove();
    }

    // -----------------------------------
    // Category selector with autocomplete
    // -----------------------------------
    const categoryInput = document.getElementById("category-input");
    const selectedContainer = document.getElementById("selected-categories");
    const selectedIds = new Set();

    function addCategoryByName(name) {
        name = name.trim();
        if (!name) return;

        const cat = categoriesData.find(c => c.name === name);
        if (!cat) {
            // No exact match -> do nothing (or show a message if you want)
            return;
        }
        if (selectedIds.has(cat.id)) {
            // Already selected
            return;
        }

        selectedIds.add(cat.id);

        const pill = document.createElement("span");
        pill.className = "selected-category-pill";
        pill.textContent = cat.name;

        // Hidden input for form submission
        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "category_ids";
        hidden.value = cat.id;
        pill.appendChild(hidden);

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "remove-category-btn";
        removeBtn.textContent = "Ã—";
        removeBtn.onclick = () => {
            selectedIds.delete(cat.id);
            pill.remove();
        };

        pill.appendChild(removeBtn);
        selectedContainer.appendChild(pill);
    }

    categoryInput.addEventListener("change", () => {
        addCategoryByName(categoryInput.value);
        categoryInput.value = "";
    });

    categoryInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            addCategoryByName(categoryInput.value);
            categoryInput.value = "";
        }
    });

})();
</script>

{% endblock %}
