{% extends "base.html" %}

{% block content %}
<h2>Add New Word</h2>

<div class="admin-add-word-container">
<form method="post" class="admin-add-word-form">

    <p>
        <label>Word:</label><br>
        <input type="text" name="word" required class="admin-input">
    </p>

    <p>
        <label>Part of Speech:</label><br>
        <select name="pos_id" required class="admin-select">
            {% for pos in pos_list %}
            <option value="{{ pos['id'] }}">{{ pos['name'] }}</option>
            {% endfor %}
        </select>
    </p>

    <p>
        <label>Category (optional):</label><br>
        <select name="category_id" class="admin-select">
            <option value="">-- None --</option>
            {% for cat in categories %}
            <option value="{{ cat['id'] }}">{{ cat['name'] }}</option>
            {% endfor %}
        </select>
    </p>

    <hr>
    <h3>Meanings</h3>
    <div id="meanings-container" class="meanings-section">
        <div class="meaning-block" data-meaning-number="1">
         
            <p>Translations:</p>
            <div id="translations-1" class="translations-group">
                <input type="text" name="translations_1[]" class="admin-input"><br>
            </div>
            <button type="button" onclick="addTranslation(1)">+ Add Translation</button>

            <p>Examples:</p>
            <div id="examples-1" class="examples-group">
                <div class="example-pair">
                    <input type="text" name="examples_1[]" class="admin-input" placeholder="Example">
                    <input type="text" name="examples_trans_1[]" class="admin-input" placeholder="Translation">
                </div>
            </div>
            <button type="button" onclick="addExample(1)">+ Add Example</button>

            <input type="hidden" name="meaning_number[]" value="1">
            <p>Notes: <input type="text" name="meaning_notes[]" class="admin-input"></p>
        </div>
    </div>

    <button type="button" onclick="addMeaning()" class="admin-btn">+ Add Meaning</button>

    <p>
        <button type="submit" class="admin-btn">Add Word</button>
    </p>
</form>
</div>

<script>
(function(){
    let meaningCount = 1;

    function addTranslation(num) {
        const container = document.getElementById(`translations-${num}`);
        const wrapper = document.createElement('div');
        wrapper.className = 'translation-item';
        const input = document.createElement('input');
        input.type = 'text';
        input.name = `translations_${num}[]`;
        input.className = 'admin-input';
        input.placeholder = 'Translation';
        wrapper.appendChild(input);
        container.appendChild(wrapper);
    }

    function addExample(num) {
        const container = document.getElementById(`examples-${num}`);
        const wrapper = document.createElement('div');
        wrapper.className = 'example-pair';
        const text = document.createElement('input');
        text.type = 'text';
        text.name = `examples_${num}[]`;
        text.className = 'admin-input';
        text.placeholder = 'Example';
        const trans = document.createElement('input');
        trans.type = 'text';
        trans.name = `examples_trans_${num}[]`;
        trans.className = 'admin-input';
        trans.placeholder = 'Translation';
        wrapper.appendChild(text);
        wrapper.appendChild(trans);
        container.appendChild(wrapper);
    }

    window.addMeaning = function() {
        meaningCount++;
        const container = document.getElementById('meanings-container');
        const div = document.createElement('div');
        div.className = 'meaning-block';
        div.dataset.meaningNumber = meaningCount;
        div.innerHTML = `
            <input type="hidden" name="meaning_number[]" value="${meaningCount}">
            <p>Translations:</p>
            <div id="translations-${meaningCount}" class="translations-group">
                <input type="text" name="translations_${meaningCount}[]" class="admin-input" placeholder="Translation"><br>
            </div>
            <button type="button" onclick="addTranslation(${meaningCount})">+ Add Translation</button>

            <p>Examples:</p>
            <div id="examples-${meaningCount}" class="examples-group">
                <div class="example-pair">
                    <input type="text" name="examples_${meaningCount}[]" class="admin-input" placeholder="Example">
                    <input type="text" name="examples_trans_${meaningCount}[]" class="admin-input" placeholder="Translation">
                </div>
            </div>
            <button type="button" onclick="addExample(${meaningCount})">+ Add Example</button>
            <p>Notes: <input type="text" name="meaning_notes[]" class="admin-input"></p>
        `;
        container.appendChild(div);
    }

    window.addTranslation = addTranslation;
    window.addExample = addExample;
})();



// Validation: alert + highlight + scroll
document.querySelector('.admin-add-word-form').addEventListener('submit', function(e) {
    const meaningBlocks = document.querySelectorAll('.meaning-block');
    let valid = true;

    // Clear previous highlights
    meaningBlocks.forEach(block => block.style.border = 'none');

    meaningBlocks.forEach((block, idx) => {
        const num = block.dataset.meaningNumber;
        const translations = block.querySelectorAll(`input[name="translations_${num}[]"]`);
        const hasTranslation = Array.from(translations).some(input => input.value.trim() !== '');

        if (!hasTranslation && valid) { // first invalid block
            valid = false;

            // Alert
            alert(`Meaning #${num} must have at least one translation.`);

            // Highlight the meaning block
            block.style.border = '2px solid red';
            block.style.padding = '10px';

            // Scroll into view
            block.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });

    if (!valid) {
        e.preventDefault(); // Stop form submission
    }
});



</script>
{% endblock %}
