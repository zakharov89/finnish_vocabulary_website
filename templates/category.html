{% extends "base.html" %}
{% block content %}

{# ---- Level pills at the very top (same as other pages) ---- #}
<form id="levels-form" class="level-pill-form" style="margin-bottom: 12px;">
    <div class="level-pill-container" style="display:flex; flex-wrap:wrap; gap:10px;">
        {% for level in levels %}
        <label class="level-pill"
               data-level-id="{{ level.id }}">
            {{ level.name }}
        </label>
        {% endfor %}

        <label class="level-pill select-all-pill">
            Select All
        </label>
    </div>
</form>

{# ---- Topic title ---- #}
<h2 style="margin-bottom: 0.6em;">{{ category['name'] }}</h2>

{# ---- Subtopics panel (button just under the title) ---- #}
{% if subcategories %}
<div class="subtopics-wrapper" style="margin-bottom: 1.5em;">
    <button type="button"
            id="toggle-subtopics"
            class="apply-button"
            style="margin-bottom: 8px;">
        Show subtopics
    </button>

    <div id="subtopics-section"
         class="subcategories-section"
         style="margin-top: 4px; display:none;">
        <div class="category-grid">
            {% for sub in subcategories %}
            <div class="category-card">
                <div class="category-header">
                    <a href="{{ url_for('show_category', category_name=sub['name']) }}" class="category-link">
                        <span class="title">
                            {{ sub['name'] }}
                            {% if sub['count'] is defined %}
                                <span style="font-size:0.8em; color:#666;">({{ sub['count'] }})</span>
                            {% endif %}
                        </span>
                    </a>
                    {% if categories.get(sub['id']) %}
                      <button type="button"
                              class="subcat-toggle"
                              data-cat-id="{{ sub['id'] }}">
                          ▼
                      </button>
                    {% endif %}
                </div>

                {% if categories.get(sub['id']) %}
                <div class="subcats" data-subcats-for="{{ sub['id'] }}" style="display: none;">
                    {% for child in categories.get(sub['id']) %}
                        <a class="subcat" href="{{ url_for('show_category', category_name=child['name']) }}">
                            {{ child['name'] }}
                        </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>


{# ---- Include-subtopics: highlighted box ---- #}
<div class="include-subs-wrapper"
     style="margin: 4px 0 18px 0;">
    <label for="include-subs-checkbox"
           class="include-subs-box"
           style="
                display:flex;
                flex-direction:column;
                gap:4px;
                padding:10px 14px;
                border-radius:10px;
                background: #f3f8ff;
                border: 1px solid #d5e4ff;
                box-shadow: 0 1px 4px rgba(0, 60, 150, 0.04);
                max-width:460px;
            ">
            <span style="display:flex; align-items:center; gap:10px;">
            <input type="checkbox"
                   id="include-subs-checkbox"
                   style="transform: scale(1.15);"
                   {% if include_subs %}checked{% endif %}>
            <span class="include-subs-title"
                  style="font-weight:600; font-size:0.98em;">
                Include words from subtopics
            </span>
        </span>
    
    </label>
</div>

{% endif %}

{# ---- View switcher (same style as words page) ---- #}
<div class="view-switcher" style="margin: 10px 0; display: flex; gap: 15px; flex-wrap: wrap;">

    <a href="#"
       class="apply-button {% if view == 'cards' %}active-view{% endif %}"
       data-view="cards">
        Card View
    </a>

    <a href="#"
       class="apply-button {% if view == 'table' %}active-view{% endif %}"
       data-view="table">
        Table View
    </a>

    <a href="#"
       class="apply-button {% if view == 'flashcards' %}active-view{% endif %}"
       data-view="flashcards">
        Flashcards
    </a>

</div>

{# ---- Words section container (AJAX target) ---- #}
<div id="category-words-container" style="margin-top: 10px;">
    {% if words %}
        {% if view == 'table' %}
            {% include "partials/words_table.html" %}
        {% elif view == 'cards' %}
            {% include "partials/words_cards.html" %}
        {% else %}
            {% include "partials/words_flashcards.html" %}
        {% endif %}
    {% else %}
        <p>No words in this topic for the selected levels.</p>
    {% endif %}
</div>

{# ---- Breadcrumb ---- #}
{% if parent %}
<p class="breadcrumb" style="margin-top: 1.5em;">
    <a href="{{ url_for('show_category', category_name=parent['name']) }}">Back to {{ parent['name'] }}</a>
</p>
{% else %}
<p class="breadcrumb" style="margin-top: 1.5em;">
    <a href="{{ url_for('categories') }}">Back to all topics</a>
</p>
{% endif %}

<script>
let currentView = "{{ view }}";
let currentIncludeSubs = {{ 1 if include_subs else 0 }};

// ---- Level helpers ----
function getSelectedLevels() {
    return Array.from(document.querySelectorAll('.level-pill.selected[data-level-id]'))
                .map(p => p.dataset.levelId);
}

function updateSelectAllLabel() {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    const btn = document.querySelector('.select-all-pill');
    if (!btn || allPills.length === 0) return;

    const allSelected = Array.from(allPills).every(p => p.classList.contains('selected'));
    btn.textContent = allSelected ? 'Deselect All' : 'Select All';
}

function sendSelectedLevels(selectedLevels) {
    const wordsContainer = document.getElementById('category-words-container');
    if (!wordsContainer) return;

    // 1) Save levels globally
    fetch('{{ url_for("set_levels") }}', {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            'X-CSRFToken': '{{ csrf_token() if csrf_token is defined }}'
        },
        body: JSON.stringify({ levels: selectedLevels })
    })
    .then(resp => resp.json())
    .then(() => {
        // 2) Update just the words section for the current view & include_subs
        return fetch('{{ url_for("category_update_view", category_name=category["name"]) }}', {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': '{{ csrf_token() if csrf_token is defined }}'
            },
            body: JSON.stringify({ view: currentView, include_subs: currentIncludeSubs })
        });
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.html) {
            wordsContainer.innerHTML = data.html;
            bindFlashcards();  // re-bind after DOM update
        }
    })
    .catch(err => console.error("Error updating levels:", err));
}

function toggleAllLevels() {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    if (allPills.length === 0) return;

    const allSelected = Array.from(allPills).every(p => p.classList.contains('selected'));

    allPills.forEach(p => p.classList.toggle('selected', !allSelected));

    updateSelectAllLabel();
    sendSelectedLevels(getSelectedLevels());
}

function initLevelPills() {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    const selectedFromServer = {{ selected_levels | tojson }};

    allPills.forEach(pill => {
        const id = parseInt(pill.dataset.levelId);
        if (selectedFromServer.includes(id)) {
            pill.classList.add('selected');
        }

        pill.addEventListener('click', () => {
            pill.classList.toggle('selected');
            updateSelectAllLabel();
            sendSelectedLevels(getSelectedLevels());
        });
    });

    const selectAll = document.querySelector('.select-all-pill');
    if (selectAll) {
        selectAll.addEventListener('click', toggleAllLevels);
    }

    updateSelectAllLabel();
}

// ---- Subtopic arrow toggles (inside cards) ----
function bindSubcategoryToggles() {
    document.querySelectorAll('.subcat-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
            const catId = toggle.dataset.catId;
            const subcats = document.querySelector(`[data-subcats-for="${catId}"]`);
            if (!subcats) return;

            const isHidden =
                subcats.style.display === 'none' ||
                subcats.style.display === '';

            subcats.style.display = isHidden ? 'block' : 'none';
            toggle.textContent = isHidden ? '▲' : '▼';
        });
    });
}

// ---- Whole subtopics panel toggle ----
function bindSubtopicsPanelToggle() {
    const btn = document.getElementById('toggle-subtopics');
    const panel = document.getElementById('subtopics-section');
    if (!btn || !panel) return;

    btn.addEventListener('click', () => {
        const isHidden = panel.style.display === 'none' || panel.style.display === '';
        panel.style.display = isHidden ? 'block' : 'none';
        btn.textContent = isHidden ? 'Hide subtopics' : 'Show subtopics';
    });
}

// ---- Include subtopics checkbox (words) ----
function bindIncludeSubsCheckbox() {
    const cb = document.getElementById('include-subs-checkbox');
    const wordsContainer = document.getElementById('category-words-container');
    if (!cb || !wordsContainer) return;

    cb.addEventListener('change', () => {
        currentIncludeSubs = cb.checked ? 1 : 0;

        fetch('{{ url_for("category_update_view", category_name=category["name"]) }}', {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': '{{ csrf_token() if csrf_token is defined }}'
            },
            body: JSON.stringify({ view: currentView, include_subs: currentIncludeSubs })
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.html) {
                wordsContainer.innerHTML = data.html;
                bindFlashcards();
            }
        })
        .catch(err => console.error("Error toggling include_subs:", err));
    });
}

// ---- Flashcard flip ----
function bindFlashcards() {
    document.querySelectorAll('.flashcard').forEach(card => {
        card.addEventListener('click', () => {
            card.classList.toggle('flipped');
        });
    });
}

// ---- View switcher (AJAX) ----
function bindCategoryViewSwitcher() {
    const buttons = document.querySelectorAll('.view-switcher .apply-button');
    const container = document.getElementById('category-words-container');
    if (!buttons || !container) return;

    buttons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const view = this.dataset.view;
            if (!view) return;

            // update active button
            buttons.forEach(b => b.classList.remove('active-view'));
            this.classList.add('active-view');
            currentView = view;

            fetch('{{ url_for("category_update_view", category_name=category["name"]) }}', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    'X-CSRFToken': '{{ csrf_token() if csrf_token is defined }}'
                },
                body: JSON.stringify({ view: view, include_subs: currentIncludeSubs })
            })
            .then(resp => resp.json())
            .then(data => {
                if (data.html) {
                    container.innerHTML = data.html;
                    bindFlashcards();
                }
            })
            .catch(err => console.error("Error updating topic view:", err));
        });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initLevelPills();
    bindSubcategoryToggles();
    bindSubtopicsPanelToggle();
    bindIncludeSubsCheckbox();
    bindFlashcards();
    bindCategoryViewSwitcher();
});
</script>

{% endblock %}
