{% extends "base.html" %}
{% block content %}

<!-- ==========================
     LEVELS SUMMARY (always visible)
========================== -->
<div id="levels-summary-row" style="margin-bottom:10px;">
    <span style="color:#555;">Levels:</span>
    <span id="levels-summary-label">All levels</span>
    <a href="#" id="levels-change-link" style="margin-left:8px;">Change</a>
</div>

<!-- ==========================
     LEVEL SELECTOR (collapsible)
========================== -->
<form id="levels-form" class="level-pill-form" style="margin-bottom: 12px; display:none;">

    <!-- Scrollable row of level pills -->
    <div class="levels-scroll" 
         style="
            display: flex; 
            gap: 8px; 
            overflow-x: auto; 
            padding-bottom: 6px; 
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
         ">
         
        <!-- All numbered levels (1..5 or whatever exists) -->
        {% for level in levels if level.id != 0 %}
        <label class="level-pill"
               data-level-id="{{ level.id }}"
               style="flex: 0 0 auto;">
            {{ level.id }}
        </label>
        {% endfor %}

        <!-- Level 0 as "+" at the end -->
        {% for level in levels if level.id == 0 %}
        <label class="level-pill"
               data-level-id="0"
               style="flex: 0 0 auto;">
            +
        </label>
        {% endfor %}
    </div>

    <!-- Select All button -->
    <button type="button" 
            class="level-pill select-all-pill"
            id="select-all-btn"
            style="margin-top: 10px; width: 100%; text-align:center;">
        Select All
    </button>

</form>


<!-- ==========================
     CATEGORY TITLE
========================== -->
<h2 style="margin-bottom:0.6em;">{{ category['name'] }}</h2>

<!-- ==========================
     SUBTOPICS TOGGLE PANEL
========================== -->
{% if subcategories %}
<div class="subtopics-wrapper" style="margin-bottom:1.2em;">

    <button type="button"
            id="toggle-subtopics"
            class="apply-button"
            style="margin-bottom:8px;">
        Show subtopics
    </button>

    <div id="subtopics-section"
         style="margin-top:4px; display:none;">
        {% include "partials/category_subtopics.html" %}
    </div>

    <!-- INCLUDE SUBTOPICS CHECKBOX -->
    <div class="include-subs-wrapper" style="margin-top:4px;">
        <label class="include-subs-box"
               style="
                   display:flex;
                   flex-direction:column;
                   gap:4px;
                   padding:10px 14px;
                   border-radius:10px;
                   background:#f3f8ff;
                   border:1px solid #d5e4ff;
                   box-shadow:0 1px 4px rgba(0,60,150,0.04);
                   max-width:250px;">
            <span style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox"
                       id="include-subs-checkbox"
                       style="transform:scale(1.15);"
                       {% if include_subs %}checked{% endif %}>
                <span style="font-weight:600; font-size:0.9em;">
                    Include words from subtopics
                </span>
            </span>
        </label>
    </div>
</div>
{% endif %}

<!-- ==========================
     VIEW SWITCHER
========================== -->
<div class="view-switcher"
     style="margin:10px 0; display:flex; gap:15px; flex-wrap:wrap;">
    <a href="#" class="apply-button {% if view == 'table' %}active-view{% endif %}"
       data-view="table">Table View</a>

    <a href="#" class="apply-button {% if view == 'cards' %}active-view{% endif %}"
       data-view="cards">Card View</a>

    <a href="#" class="apply-button {% if view == 'flashcards' %}active-view{% endif %}"
       data-view="flashcards">Flashcards</a>
</div>

<!-- ==========================
     WORDS CONTENT AREA (AJAX updated)
========================== -->
<div id="category-words-container" style="margin-top:10px;">
    {% if words %}
        {% if view == 'table' %}
            {% include "partials/words_table.html" %}
        {% elif view == 'cards' %}
            {% include "partials/words_cards.html" %}
        {% else %}
            {% include "partials/words_flashcards.html" %}
        {% endif %}
    {% else %}
        <p>No words in this topic for the selected levels.</p>
    {% endif %}
</div>

<!-- ==========================
     BREADCRUMB
========================== -->
{% if parent %}
<p class="breadcrumb" style="margin-top:1.5em;">
    <a href="{{ url_for('show_category', category_name=parent['name']) }}">
        Back to {{ parent['name'] }}
    </a>
</p>
{% else %}
<p class="breadcrumb" style="margin-top:1.5em;">
    <a href="{{ url_for('categories') }}">Back to all topics</a>
</p>
{% endif %}

<!-- ==========================
     JAVASCRIPT
========================== -->
<script>
let currentView = "{{ view }}";
let currentIncludeSubs = {{ 1 if include_subs else 0 }};

function getSelectedLevels() {
    return Array.from(document.querySelectorAll('.level-pill.selected[data-level-id]'))
                .map(p => p.dataset.levelId);
}

function updateLevelsSummary() {
    const label = document.getElementById('levels-summary-label');
    const pills = [...document.querySelectorAll('.level-pill[data-level-id]')];
    const selected = pills.filter(p => p.classList.contains('selected'));

    if (selected.length === 0)
        label.textContent = "No levels selected";
    else if (selected.length === pills.length)
        label.textContent = "All levels";
    else
        label.textContent = selected.map(p => p.textContent.trim()).join(", ");
}

function updateSelectAllLabel() {
    const btn = document.getElementById('select-all-btn');
    const pills = [...document.querySelectorAll('.level-pill[data-level-id]')];
    if (!btn || !pills.length) return;

    const allSelected = pills.every(p => p.classList.contains('selected'));
    btn.textContent = allSelected ? "Deselect All" : "Select All";
}

function sendSelectedLevels(levels) {
    fetch('{{ url_for("set_levels") }}', {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ levels })
    })
    .then(() => {
        return fetch('{{ url_for("category_update_view", category_name=category["name"]) }}', {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                view: currentView,
                include_subs: currentIncludeSubs
            })
        });
    })
    .then(resp => resp.json())
    .then(data => {
        const container = document.getElementById('category-words-container');
        if (data.words_html) container.innerHTML = data.words_html;
        if (data.subtopics_html) {
            const subs = document.getElementById('subtopics-section');
            if (subs) subs.innerHTML = data.subtopics_html;
        }
    });
}

function initLevelPills() {
    const selectedFromServer = {{ selected_levels | tojson }};
    const pills = document.querySelectorAll('.level-pill[data-level-id]');

    pills.forEach(pill => {
        const id = parseInt(pill.dataset.levelId);
        if (selectedFromServer.includes(id)) {
            pill.classList.add('selected');
        }

        pill.addEventListener('click', () => {
            pill.classList.toggle('selected');
            updateSelectAllLabel();
            updateLevelsSummary();
            sendSelectedLevels(getSelectedLevels());
        });
    });

    const selectAllBtn = document.getElementById('select-all-btn');
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', () => {
            const all = [...document.querySelectorAll('.level-pill[data-level-id]')];
            const allSelected = all.every(p => p.classList.contains('selected'));
            all.forEach(p => p.classList.toggle('selected', !allSelected));
            updateSelectAllLabel();
            updateLevelsSummary();
            sendSelectedLevels(getSelectedLevels());
        });
    }

    updateSelectAllLabel();
    updateLevelsSummary();
}

function bindSubtopicsPanelToggle() {
    const btn = document.getElementById('toggle-subtopics');
    const panel = document.getElementById('subtopics-section');
    if (!btn || !panel) return;

    btn.addEventListener('click', () => {
        const hidden = panel.style.display !== 'block';
        panel.style.display = hidden ? 'block' : 'none';
        btn.textContent = hidden ? "Hide subtopics" : "Show subtopics";
    });
}

function bindIncludeSubsCheckbox() {
    const cb = document.getElementById('include-subs-checkbox');
    const wordsContainer = document.getElementById('category-words-container');
    if (!cb || !wordsContainer) return;  // ðŸ”´ important guard

    cb.addEventListener('change', () => {
        currentIncludeSubs = cb.checked ? 1 : 0;

        fetch('{{ url_for("category_update_view", category_name=category["name"]) }}', {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                view: currentView,
                include_subs: currentIncludeSubs
            })
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.words_html) {
                wordsContainer.innerHTML = data.words_html;
            }
        });
    });
}

function bindCategoryViewSwitcher() {
    const buttons = document.querySelectorAll('.view-switcher .apply-button');
    const container = document.getElementById('category-words-container');
    if (!buttons.length || !container) return;

    buttons.forEach(btn => {
        btn.addEventListener('click', e => {
            e.preventDefault();
            const view = btn.dataset.view;
            if (!view) return;

            currentView = view;
            buttons.forEach(b => b.classList.remove('active-view'));
            btn.classList.add('active-view');

            fetch('{{ url_for("category_update_view", category_name=category["name"]) }}', {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    view,
                    include_subs: currentIncludeSubs
                })
            })
            .then(resp => resp.json())
            .then(data => {
                if (data.words_html) {
                    container.innerHTML = data.words_html;
                }
            });
        });
    });
}

function bindLevelsSummaryToggle() {
    const link = document.getElementById('levels-change-link');
    const form = document.getElementById('levels-form');
    if (!link || !form) return;

    link.addEventListener('click', e => {
        e.preventDefault();
        const hidden = form.style.display !== 'block';
        form.style.display = hidden ? 'block' : 'none';
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initLevelPills();
    bindSubtopicsPanelToggle();
    bindIncludeSubsCheckbox();    // now safe if checkbox doesn't exist
    bindCategoryViewSwitcher();
    bindLevelsSummaryToggle();
});
</script>

{% endblock %}
