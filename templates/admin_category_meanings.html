{% extends "base.html" %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<h2>Choosing Meanings for Category: {{ category['name'] }}</h2>

<p>
    <a href="{{ url_for('show_category', category_name=category['name']) }}" 
       class="admin-btn-small" 
       target="_blank">
        View Category Page
    </a>
</p>

<form method="POST" action="{{ url_for('admin_category_meanings', category_id=category['id']) }}">
    <table class="admin-table" id="word-table">
    <thead>
        <tr>
            <th style="width: 35px;"></th>  <!-- drag handle -->
            <th>Word</th>
            <th>Meaning choice</th>
        </tr>
    </thead>

    <tbody id="sortable-rows">
    {% for word in words %}
        <tr data-word-id="{{ word['word_id'] }}">
            <!-- drag handle -->
            <td class="drag-handle" style="cursor: grab;">â˜°</td>

            <td>
                <a href="{{ url_for('show_word', word_name=word['word']) }}" target="_blank">
                    {{ word['word'] }}
                </a>
            </td>

            <td>
                {% if word.meanings %}
                    <select name="rep_meaning_{{ word['word_id'] }}">
                        <option value="">-- None --</option>
                        {% for m in word.meanings %}
                            <option value="{{ m['id'] }}"
                                {% if word.get('meaning_id') == m['id'] %}selected{% endif %}>
                                {{ m['meaning_number'] }}. {{ m['translations'] }}
                            </option>
                        {% endfor %}
                    </select>
                {% else %}
                    <em>No meanings available</em>
                {% endif %}
            </td>

            <!-- hidden field for sort order -->
            <input type="hidden" name="sort_order_{{ word['word_id'] }}" value="{{ loop.index }}">
        </tr>
    {% endfor %}
    </tbody>
</table>

<button type="submit" class="admin-btn">Save</button>

<!-- SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    const tbody = document.getElementById('sortable-rows');

    new Sortable(tbody, {
        handle: '.drag-handle',
        animation: 150,
        onSort: function () {
            // Update hidden sort order fields
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, idx) => {
                const wordId = row.dataset.wordId;
                const hidden = row.querySelector(`input[name="sort_order_${wordId}"]`);
                if (hidden) hidden.value = idx + 1;
            });
        }
    });
</script>


</form>

<p>
    <a href="{{ url_for('admin_edit_category', category_id=category.id) }}" class="admin-btn-small">
        Back to Category Edit
    </a>
</p>

{% endblock %}
