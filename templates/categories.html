{% extends "base.html" %}
{% block content %}

<form id="levels-form" class="level-pill-form" style="margin-bottom: 12px;">
    <div class="level-pill-container" style="display:flex; flex-wrap:wrap; gap:10px;">

        {% for level in levels %}
        <label class="level-pill"
               data-level-id="{{ level.id }}">
            {{ level.name }}
        </label>
        {% endfor %}

        <label class="level-pill select-all-pill">
            Select All
        </label>
    </div>
</form>


<div id="categories-container">
    {% include "partials/categories_grid.html" %}
</div>

<script>
// ---- Level helpers ----
function getSelectedLevels() {
    return Array.from(document.querySelectorAll('.level-pill.selected[data-level-id]'))
                .map(p => p.dataset.levelId);
}

function updateSelectAllLabel() {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    const btn = document.querySelector('.select-all-pill');
    if (!btn || allPills.length === 0) return;

    const allSelected = Array.from(allPills).every(p => p.classList.contains('selected'));
    btn.textContent = allSelected ? 'Deselect All' : 'Select All';
}

function sendSelectedLevels(selectedLevels) {
    console.log("Sending levels:", selectedLevels); // DEBUG

    fetch("/categories/filter", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ levels: selectedLevels })
    })
    .then(resp => resp.json())
    .then(data => {
        console.log("Response from /categories/filter:", data); // DEBUG
        if (data.html) {
            const container = document.getElementById('categories-container');
            container.innerHTML = data.html;
            bindExpandButtons();
        }
    })
    .catch(err => console.error("Error updating categories:", err));
}

function toggleAllLevels() {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    if (allPills.length === 0) return;

    const allSelected = Array.from(allPills).every(p => p.classList.contains('selected'));

    allPills.forEach(p => p.classList.toggle('selected', !allSelected));

    updateSelectAllLabel();
    sendSelectedLevels(getSelectedLevels());
}

function resetLevels() {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    allPills.forEach(p => p.classList.add('selected'));
    updateSelectAllLabel();
    sendSelectedLevels(getSelectedLevels());
}

function initLevelPills() {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    const selectedFromServer = {{ selected_levels | tojson }};

    allPills.forEach(pill => {
        const id = parseInt(pill.dataset.levelId);
        if (selectedFromServer.includes(id)) {
            pill.classList.add('selected');
        }

        pill.addEventListener('click', () => {
            pill.classList.toggle('selected');
            updateSelectAllLabel();
            sendSelectedLevels(getSelectedLevels());
        });
    });

    const selectAll = document.querySelector('.select-all-pill');
    if (selectAll) {
        selectAll.addEventListener('click', toggleAllLevels);
    }


    updateSelectAllLabel();
}


// ---- Expand buttons (arrow toggles) ----
function bindExpandButtons() {
    document.querySelectorAll('.subcat-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
            const catId = toggle.dataset.catId;
            const subcats = document.querySelector(`[data-subcats-for="${catId}"]`);
            if (!subcats) return;

            const isHidden =
                subcats.style.display === 'none' ||
                subcats.style.display === '';

            // Toggle subcats
            subcats.style.display = isHidden ? 'block' : 'none';

            // Swap arrow
            toggle.textContent = isHidden ? '▲' : '▼';
        });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initLevelPills();
    bindExpandButtons();
});
</script>

{% endblock %}
