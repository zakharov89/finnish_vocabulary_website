{% extends "base.html" %}
{% block content %}

<style>
/* ============================================
   LEVELS SUMMARY PANEL — RESPONSIVE WIDTH
============================================ */

/* Mobile: full width */
.levels-summary-row {
    width: 100%;
    box-sizing: border-box;

    display: flex;
    align-items: center;
    justify-content: space-between;

    padding: 6px 10px;
    margin: 0 0 10px 0;

    border-radius: 10px;
    background: #f5f7ff;
    border: 1px solid #dde5ff;

    font-size: 0.9rem;
    gap: 8px;
}

/* Desktop: narrower + left-aligned */
@media (min-width: 900px) {
    .levels-summary-row {
        max-width: 520px;
        margin-left: 0;
        margin-right: auto;
    }
}

.levels-summary-label-wrap {
    display: flex;
    align-items: baseline;
    gap: 4px;
    flex-wrap: wrap;
}

.levels-summary-label-wrap span:first-child {
    color: #555;
    font-weight: 500;
}

#levels-summary-label {
    font-weight: 600;
    color: #1a237e;
}

/* "Change levels ▾" button */
#levels-change-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;

    padding: 4px 10px;
    border-radius: 999px;

    border: 1px solid #c4d2ff;
    background: #ffffff;
    font-size: 0.85rem;
    color: #1a3aa8;
    text-decoration: none;
    white-space: nowrap;
}

#levels-change-link:hover {
    background: #eef2ff;
    text-decoration: none;
}

#levels-change-arrow {
    font-size: 0.8em;
    margin-top: 1px;
}

/* ============================================
   LEVELS SCROLL ROW + SELECT ALL
============================================ */

.levels-scroll {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    padding: 6px 2px 10px;
    margin-bottom: 6px;
    -webkit-overflow-scrolling: touch;
}

.levels-scroll::-webkit-scrollbar {
    height: 4px;
}

.levels-scroll::-webkit-scrollbar-thumb {
    border-radius: 999px;
    background: #ccd4ff;
}

/* Select All pill */
#select-all-btn.select-all-pill {
    margin-top: 2px;
    font-size: 0.85rem;
    padding: 4px 10px;
    align-self: flex-start;
}

@media (min-width: 768px) {
    #select-all-btn.select-all-pill {
        font-size: 0.8rem;
        padding: 3px 10px;
    }
}

/* ===== CATEGORY GRID & CARDS (visual only) ===== */

.category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 16px;
    margin-top: 10px;
}

/* Card look – whole card is clickable now */
.category-card {
    background: #f5f7ff;
    border: 1px solid #dde5ff;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
    cursor: pointer; /* key: show it's clickable */
}

/* Hover state */
.category-card:hover {
    background: #eef2ff;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
}

/* Header row: name+count on left, arrow on right */
.category-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
}

/* Make the link area (name+count) a nice block */
.category-link {
    display: inline-flex;
    align-items: baseline;
    gap: 6px;
    text-decoration: none;
    color: #1a237e;  /* heading blue */
    font-weight: 600;
}

.category-link:hover {
    text-decoration: underline;
}

.category-count {
    font-size: 0.85rem;
    color: #666;
}

/* ===== SUBCATEGORY ARROWS – big, clear ▲▼ ===== */
.subcat-toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;

    width: 28px;
    height: 28px;

    margin-left: 4px;

    border-radius: 50%;
    border: 1px solid #b9c4ff;
    background: #f0f3ff;

    font-size: 16px;
    font-weight: 700;
    line-height: 1;
    cursor: pointer;
    padding: 0;

    color: #1a2a7a;
    transition: background 0.15s ease, transform 0.15s ease;
    flex-shrink: 0;
}

.subcat-toggle:hover {
    background: #e2e7ff;
}

.subcat-toggle.open {
    background: #d3dcff;
}

/* ===== SUBCATEGORIES LIST ===== */

.subcats {
    margin-top: 8px;
    padding-left: 0;
}

/* Individual subcategory link */
.subcat {
    display: block;
    margin: 2px 0;
    font-size: 0.9rem;
    text-decoration: none;
}

.subcat-name {
    color: #1a73e8;
}

.subcat-count {
    font-size: 0.8rem;
    color: #666;
}

.subcat:hover .subcat-name {
    text-decoration: underline;
}

/* Optional: dim empty categories */
.category-card--empty,
.subcat--empty .subcat-name {
    opacity: 0.55;
}

/* Disable text selection inside category cards */
.category-card * {
    user-select: none;
}

/* Remove underline from the category title on hover */
.category-link:hover {
    text-decoration: none !important;
}

</style>

<!-- ==========================
     LEVELS SUMMARY (always visible)
========================== -->
<div id="levels-summary-row" class="levels-summary-row">
    <div class="levels-summary-label-wrap">
        <span>Levels:</span>
        <span id="levels-summary-label">All levels</span>
    </div>

    <a href="#"
       id="levels-change-link"
       aria-expanded="false">
        <span id="levels-change-text">Change levels</span>
        <span id="levels-change-arrow" aria-hidden="true">▾</span>
    </a>
</div>

<!-- ==========================
     LEVEL SELECTOR (collapsible)
========================== -->
<form id="levels-form" class="level-pill-form" style="margin-bottom: 12px; display:none;">
    <div class="levels-scroll">
        {% for level in levels if level.id != 0 %}
        <label class="level-pill"
               data-level-id="{{ level.id }}"
               style="flex: 0 0 auto;">
            {{ level.name }}
        </label>
        {% endfor %}

        {% for level in levels if level.id == 0 %}
        <label class="level-pill"
               data-level-id="0"
               style="flex: 0 0 auto;">
            +
        </label>
        {% endfor %}
    </div>

    <button type="button"
            class="level-pill select-all-pill"
            id="select-all-btn">
        Select All
    </button>
</form>

<div id="categories-container">
    {% include "partials/categories_grid.html" %}
</div>

<script>
// ---- Level helpers ----
function getSelectedLevels() {
    return Array.from(document.querySelectorAll('.level-pill.selected[data-level-id]'))
                .map(p => p.dataset.levelId);
}

function updateLevelsSummary() {
    const label = document.getElementById('levels-summary-label');
    const pills = [...document.querySelectorAll('.level-pill[data-level-id]')];
    const selected = pills.filter(p => p.classList.contains('selected'));

    if (!label) return;

    if (selected.length === 0) {
        label.textContent = "No levels selected";
    } else if (selected.length === pills.length) {
        label.textContent = "All levels";
    } else {
        label.textContent = selected.map(p => p.textContent.trim()).join(", ");
    }
}

function updateSelectAllLabel() {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    const btn = document.querySelector('.select-all-pill');
    if (!btn || allPills.length === 0) return;

    const allSelected = Array.from(allPills).every(p => p.classList.contains('selected'));
    btn.textContent = allSelected ? 'Deselect All' : 'Select All';
}

function sendSelectedLevels(selectedLevels) {
    fetch("/categories/filter", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ levels: selectedLevels })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.html) {
            const container = document.getElementById('categories-container');
            container.innerHTML = data.html;

            // Rebind behaviour for the new DOM:
            bindExpandButtons();
            bindCategoryCardClicks();
        }
    })
    .catch(err => console.error("Error updating categories:", err));
}

function toggleAllLevels() {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    if (allPills.length === 0) return;

    const allSelected = Array.from(allPills).every(p => p.classList.contains('selected'));

    allPills.forEach(p => p.classList.toggle('selected', !allSelected));

    updateSelectAllLabel();
    updateLevelsSummary();
    sendSelectedLevels(getSelectedLevels());
}

function initLevelPills() {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    const selectedFromServer = {{ selected_levels | tojson }};

    allPills.forEach(pill => {
        const id = parseInt(pill.dataset.levelId);
        if (selectedFromServer.includes(id)) {
            pill.classList.add('selected');
        }

        pill.addEventListener('click', () => {
            pill.classList.toggle('selected');
            updateSelectAllLabel();
            updateLevelsSummary();
            sendSelectedLevels(getSelectedLevels());
        });
    });

    const selectAll = document.querySelector('.select-all-pill');
    if (selectAll) {
        selectAll.addEventListener('click', (e) => {
            e.preventDefault();
            toggleAllLevels();
        });
    }

    updateSelectAllLabel();
    updateLevelsSummary();
}

// ---- Levels summary show/hide ----
function bindLevelsSummaryToggle() {
    const link = document.getElementById('levels-change-link');
    const form = document.getElementById('levels-form');
    const textEl = document.getElementById('levels-change-text');
    const arrowEl = document.getElementById('levels-change-arrow');
    if (!link || !form) return;

    const updateToggleState = (isOpen) => {
        form.style.display = isOpen ? 'block' : 'none';
        if (textEl) textEl.textContent = isOpen ? "Hide levels" : "Change levels";
        if (arrowEl) arrowEl.textContent = isOpen ? "▴" : "▾";
        link.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    };

    updateToggleState(false);

    link.addEventListener('click', e => {
        e.preventDefault();
        const isOpen = form.style.display !== 'block';
        updateToggleState(isOpen);
    });
}

// ---- Expand buttons (arrow toggles) ----
function bindExpandButtons() {
    document.querySelectorAll('.subcat-toggle').forEach(toggle => {
        if (toggle.dataset.bound === "1") return;  // avoid double-binding
        toggle.dataset.bound = "1";

        toggle.addEventListener('click', (e) => {
            // do NOT trigger card navigation
            e.stopPropagation();

            const catId = toggle.dataset.catId;
            const subcats = document.querySelector(`[data-subcats-for="${catId}"]`);
            if (!subcats) return;

            const isHidden =
                subcats.style.display === 'none' ||
                subcats.style.display === '';

            subcats.style.display = isHidden ? 'block' : 'none';
            toggle.textContent = isHidden ? '▲' : '▼';
            toggle.classList.toggle('open', isHidden);
        });
    });
}

/**
 * Make the whole category card clickable.
 * - Clicking anywhere on the card navigates to the main category link
 * - Clicks on subcategory links still work normally
 * - Clicks on the expand arrow only toggle, no navigation
 */
function bindCategoryCardClicks() {
    document.querySelectorAll('.category-card').forEach(card => {
        if (card.dataset.cardBound === "1") return;
        card.dataset.cardBound = "1";

        const mainLink = card.querySelector('.category-link');
        if (!mainLink) return;

        card.addEventListener('click', (e) => {
            // If click originated in subcategory toggle or a subcategory link, let them handle it
            if (e.target.closest('.subcat-toggle') || e.target.closest('.subcat')) {
                return;
            }
            // If click is on the main category link itself, just let the browser handle it
            if (e.target.closest('.category-link')) {
                return;
            }
            // Otherwise, simulate clicking the main link
            mainLink.click();
        });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initLevelPills();
    bindLevelsSummaryToggle();
    bindExpandButtons();
    bindCategoryCardClicks();
});
</script>

{% endblock %}
