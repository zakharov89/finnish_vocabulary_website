{% extends "base.html" %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}


<h2>Edit Word: "{{ word['word'] }}"</h2>

<div class="admin-add-word-container">
<form method="post" class="admin-add-word-form">

    <!-- Word -->
    <p>
        <label>Word:</label><br>
        <input type="text" name="word" value="{{ word['word'] }}" required class="admin-input" placeholder="Enter word">
    </p>

    <!-- Part of Speech -->
    <p>
        <label>Part of Speech:</label><br>
        <select name="pos_id" required class="admin-select">
            {% for pos in pos_list %}
            <option value="{{ pos['id'] }}" {% if pos['id'] == word['pos_id'] %}selected{% endif %}>{{ pos['name'] }}</option>
            {% endfor %}
        </select>
    </p>

    <hr>
    <h3>Meanings</h3>
    <div id="meanings-container" class="meanings-section">
        {% for meaning in meanings %}
        <div class="meaning-block" data-meaning-number="{{ meaning['meaning_number'] }}">
            <input type="hidden" name="meaning_number[]" value="{{ meaning['meaning_number'] }}">

            <p>Translations:</p>
            <div id="translations-{{ meaning['meaning_number'] }}" class="translations-group">
                {% for t in meaning['translations'] %}
                <input type="text" name="translations_{{ meaning['meaning_number'] }}[]" value="{{ t }}" class="admin-input" placeholder="Enter translation">
                {% endfor %}
            </div>
            <button type="button" class="admin-btn" onclick="addTranslation({{ meaning['meaning_number'] }})">+ Add Translation</button>

            <p>Examples (optional):</p>
            <div id="examples-{{ meaning['meaning_number'] }}" class="examples-group">
                {% if meaning['examples'] %}
                    {% for ex, ex_trans in meaning['examples'] %}
                    <div class="example-pair">
                        <input type="text" name="examples_{{ meaning['meaning_number'] }}[]" value="{{ ex }}" class="admin-input" placeholder="Enter example">
                        <input type="text" name="examples_trans_{{ meaning['meaning_number'] }}[]" value="{{ ex_trans or '' }}" class="admin-input" placeholder="Enter example translation">
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="example-pair">
                        <input type="text" name="examples_{{ meaning['meaning_number'] }}[]" class="admin-input" placeholder="Enter example">
                        <input type="text" name="examples_trans_{{ meaning['meaning_number'] }}[]" class="admin-input" placeholder="Enter example translation">
                    </div>
                {% endif %}
            </div>
            <button type="button" class="admin-btn" onclick="addExample({{ meaning['meaning_number'] }})">+ Add Example</button>

            <p>Finnish definition (optional):</p>
            <input type="text" name="definition_{{ meaning['meaning_number'] }}" class="admin-input" 
                placeholder="Enter Finnish definition" value="{{ meaning['definition'] or '' }}">

            <p>Notes (optional):</p>
            <input type="text" name="meaning_notes[]" class="admin-input" placeholder="Enter notes" value="{{ meaning['notes'] or '' }}">

            {% if loop.index > 1 %}
            <button type="button" class="admin-btn-small delete-btn" onclick="deleteMeaning(this)">Delete Meaning</button>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <button type="button" onclick="addMeaning()" class="admin-btn">+ Add Meaning</button>

    <p>
        <button type="submit" class="admin-btn">Update Word</button>
    </p>

</form>
</div>

<hr style="margin-top:25px; margin-bottom:15px;">
<form method="post" action="{{ url_for('admin_delete_word', word_id=word['id']) }}" 
      onsubmit="return confirm('Are you sure you want to delete this word?');">
    <button type="submit" class="admin-btn delete-btn">Delete Word</button>
</form>

<p>
    <a href="{{ url_for('admin_dashboard') }}" class="admin-btn-small">Back to Dashboard</a>
</p>

<script>
(function(){
    let meaningCount = {{ meanings|length if meanings else 1 }};

    // Add a new meaning block
    window.addMeaning = function() {
        meaningCount++;
        const container = document.getElementById('meanings-container');
        const div = document.createElement('div');
        div.className = 'meaning-block';
        div.dataset.meaningNumber = meaningCount;
        div.innerHTML = `
            <input type="hidden" name="meaning_number[]" value="${meaningCount}">
            <p>Translations:</p>
            <div id="translations-${meaningCount}" class="translations-group">
                <input type="text" name="translations_${meaningCount}[]" class="admin-input" placeholder="Enter translation">
            </div>
            <button type="button" class="admin-btn" onclick="addTranslation(${meaningCount})">+ Add Translation</button>

            <p>Examples (optional):</p>
            <div id="examples-${meaningCount}" class="examples-group">
                <div class="example-pair">
                    <input type="text" name="examples_${meaningCount}[]" class="admin-input" placeholder="Enter example">
                    <input type="text" name="examples_trans_${meaningCount}[]" class="admin-input" placeholder="Enter example translation">
                </div>
            </div>
            <button type="button" class="admin-btn" onclick="addExample(${meaningCount})">+ Add Example</button>

            <p>Finnish definition (optional):</p>
            <input type="text" name="definition_${meaningCount}" class="admin-input" placeholder="Enter Finnish definition">

            <p>Notes (optional): <input type="text" name="meaning_notes[]" class="admin-input" placeholder="Enter notes"></p>

            <button type="button" class="admin-btn-small delete-btn" onclick="deleteMeaning(this)">Delete Meaning</button>
        `;
        container.appendChild(div);
        renumberMeanings();
    }

    // Add translation input
    window.addTranslation = function(num) {
        const container = document.getElementById(`translations-${num}`);
        const input = document.createElement('input');
        input.type = 'text';
        input.name = `translations_${num}[]`;
        input.className = 'admin-input';
        input.placeholder = 'Enter translation';
        container.appendChild(input);
    }

    // Add example input
    window.addExample = function(num) {
        const container = document.getElementById(`examples-${num}`);
        const div = document.createElement('div');
        div.className = 'example-pair';
        div.innerHTML = `
            <input type="text" name="examples_${num}[]" class="admin-input" placeholder="Enter example">
            <input type="text" name="examples_trans_${num}[]" class="admin-input" placeholder="Enter example translation">
        `;
        container.appendChild(div);
    }

    // Delete meaning
    window.deleteMeaning = function(button) {
        const meaningBlock = button.closest('.meaning-block');
        meaningBlock.remove();
        renumberMeanings();
    }

    // Renumber all meanings sequentially
    function renumberMeanings() {
        const allBlocks = document.querySelectorAll('.meaning-block');
        allBlocks.forEach((block, index) => {
            const newNum = index + 1;
            block.dataset.meaningNumber = newNum;

            // Update hidden input
            const hiddenInput = block.querySelector('input[name^="meaning_number"]');
            if (hiddenInput) hiddenInput.value = newNum;

            // Update translation inputs
            block.querySelectorAll('input[name^="translations_"]').forEach(input => {
                input.name = `translations_${newNum}[]`;
            });

            // Update example inputs
            block.querySelectorAll('input[name^="examples_"]').forEach(input => {
                if (input.name.includes('trans')) {
                    input.name = `examples_trans_${newNum}[]`;
                } else {
                    input.name = `examples_${newNum}[]`;
                }
            });

            // Update definition input
            const defInput = block.querySelector('input[name^="definition_"]');
            if (defInput) defInput.name = `definition_${newNum}`;

            // Update notes input
            const notesInput = block.querySelector('input[name^="meaning_notes"]');
            if (notesInput) notesInput.name = `meaning_notes[]`;

            // Show/hide delete button: first meaning cannot be deleted
            const deleteBtn = block.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.style.display = (index === 0) ? 'none' : 'inline-block';
            }
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', renumberMeanings);

})();
</script>
{% endblock %}
