<form id="levels-form" class="level-pill-form" style="margin-bottom: 12px;">
    <div class="level-pill-container" style="display:flex; flex-wrap:wrap; gap:10px;">

        <!-- Individual level pills -->
        {% for level in levels %}
        <label class="level-pill"
               data-level-id="{{ level.id }}">
            {{ level.name }}
        </label>
        {% endfor %}

        <!-- Select/Deselect All -->
        <button type="button" class="level-pill select-all-pill" onclick="toggleAllLevels(this)">
            Select All
        </button>
    </div>
</form>



<script>
// ----- Get selected levels as array of IDs -----
function getSelectedLevels() {
    return Array.from(document.querySelectorAll('.level-pill.selected[data-level-id]'))
                .map(p => p.dataset.levelId);
}

// ----- Update "Select All" / "Deselect All" label -----
function updateSelectAllLabel() {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    const btn = document.querySelector('.select-all-pill');
    if (!btn || allPills.length === 0) return;

    const allSelected = Array.from(allPills).every(p => p.classList.contains('selected'));
    btn.textContent = allSelected ? 'Deselect All' : 'Select All';
}

// ----- Helper to update words via AJAX when levels change -----
function sendSelectedLevels(selectedLevels) {
    fetch("/levels/update_view", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ levels: selectedLevels, view: window.currentView })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.html) {
            const container = document.getElementById('words-container');
            container.innerHTML = data.html;

            // Rebind flashcard flip events if needed
            if (window.currentView === "cards" || window.currentView === "flashcards") {
                document.querySelectorAll('.flashcard').forEach(card => {
                    card.addEventListener('click', () => card.classList.toggle('flipped'));
                });
            }

            // Rebind level pill clicks after HTML update
            document.querySelectorAll('.level-pill[data-level-id]').forEach(pill => {
                pill.onclick = () => {
                    pill.classList.toggle('selected');
                    updateSelectAllLabel();
                    sendSelectedLevels(getSelectedLevels());
                };
            });

            // Make sure Select All label is correct after update
            updateSelectAllLabel();
        }
    })
    .catch(err => console.error("Error updating levels:", err));
}

// ----- Toggle All button -----
function toggleAllLevels(btn) {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    if (allPills.length === 0) return;

    const allSelected = Array.from(allPills).every(p => p.classList.contains('selected'));

    // If all are selected -> deselect all, else select all
    allPills.forEach(p => p.classList.toggle('selected', !allSelected));

    updateSelectAllLabel();
    sendSelectedLevels(getSelectedLevels());
}

// ----- Initial setup for individual level pills -----
(function initLevelPills() {
    const allPills = document.querySelectorAll('.level-pill[data-level-id]');
    const selectedFromServer = {{ selected_levels | tojson }};

    allPills.forEach(pill => {
        const id = parseInt(pill.dataset.levelId);
        if (selectedFromServer.includes(id)) {
            pill.classList.add('selected');
        }

        pill.onclick = () => {
            pill.classList.toggle('selected');
            updateSelectAllLabel();
            sendSelectedLevels(getSelectedLevels());
        };
    });

    // Set correct "Select All" / "Deselect All" text on first load
    updateSelectAllLabel();
})();
</script>
