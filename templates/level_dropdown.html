<form id="levels-form" method="POST" class="level-dropdown-form">
    <div class="level-dropdown-wrapper" style="display: inline-flex; align-items: center; gap: 6px;">
        <div class="level-dropdown">
            <button type="button" class="dropdown-toggle">Select Levels â–¼</button>
            <div class="dropdown-content">
                <!-- Select/Deselect All -->
                <label class="level-pill select-all-pill" onclick="toggleAllLevels(this)">
                    Select/Deselect All
                </label>

                <!-- Levels except 0 -->
                {% for level in levels %}
                    {% if level.id != 0 %}
                    <label class="level-pill">
                        <input type="checkbox" name="levels" value="{{ level.id }}"
                               {% if level.id in selected_levels %}checked{% endif %}>
                        {{ level.name }}
                    </label>
                    {% endif %}
                {% endfor %}

                <!-- No Level at bottom -->
                {% for level in levels %}
                    {% if level.id == 0 %}
                    <label class="level-pill no-level-pill">
                        <input type="checkbox" name="levels" value="{{ level.id }}"
                               {% if level.id in selected_levels %}checked{% endif %}>
                        No Level
                    </label>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Apply button outside, right of dropdown -->
        <button type="submit" form="levels-form" class="apply-button">Apply</button>

        {% if selected_levels %}
        <div class="selected-levels">
            {% for level in levels %}
                {% if level.id in selected_levels %}
                    <span class="level-pill-selected">{{ level.name }}</span>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        </div>
</form>

<style>
/* Keep your working dropdown styles */
.level-dropdown { position: relative; display: inline-block; }
.dropdown-toggle { background-color: #e3f2fd; color: #1a237e; padding: 8px 14px; font-size: 0.95rem; border: 1px solid #1a237e; border-radius: 8px; cursor: pointer; min-width: 140px; }
.dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 180px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; padding: 10px; z-index: 100; max-height: 300px; overflow-y: auto; flex-direction: column; }
.dropdown-content.show { display: flex !important; }
.level-pill { display: flex; align-items: center; margin: 5px 0; padding: 6px 10px; border-radius: 25px; background-color: #90caf9; color: #1a237e; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; }
.level-pill:hover { background-color: #64b5f6; transform: translateY(-1px); }
.level-pill input { margin-right: 8px; }
.no-level-pill { background-color: #cfd8dc; color: #37474f; }
.select-all-pill { background-color: #ffe082; color: #424242; font-weight: bold; }
.apply-button { padding: 5px 12px; border-radius: 20px; border: none; background: linear-gradient(90deg, #64b5f6, #42a5f5); color: white; font-weight: 500; font-size: 0.85rem; cursor: pointer; }
.apply-button:hover { background: linear-gradient(90deg, #42a5f5, #1e88e5); }

</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const toggle = document.querySelector(".dropdown-toggle");
    const content = document.querySelector(".dropdown-content");

    toggle.addEventListener("click", () => content.classList.toggle("show"));
    window.addEventListener("click", e => {
        if (!toggle.contains(e.target) && !content.contains(e.target)) {
            content.classList.remove("show");
        }
    });
});

// Select/Deselect All function
function toggleAllLevels(label) {
    const form = label.closest("form");
    const checkboxes = form.querySelectorAll('input[name="levels"]');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
}
</script>
