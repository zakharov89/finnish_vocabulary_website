<form id="levels-form" class="level-pill-form">
    <div class="level-pill-container" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px;">
        {% for level in levels %}
        <label class="level-pill {% if level.id == 0 %}no-level-pill{% endif %}"
               data-level-id="{{ level.id }}">
            {{ level.name }}
        </label>
        {% endfor %}
    </div>
</form>

<style>
.level-pill {
    display: inline-flex;
    align-items: center;
    margin: 5px 3px;
    padding: 6px 14px;
    border-radius: 25px;
    background: linear-gradient(145deg, #e0f7fa, #b2ebf2);
    color: #006064;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}
.level-pill.selected {
    background: linear-gradient(145deg, #00acc1, #00838f);
    color: #fff;
    font-weight: 600;
}
.no-level-pill {
    background: linear-gradient(145deg, #b0bec5, #90a4ae);
    color: #fff;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Initialize selected pills from server
    const selectedLevels = {{ selected_levels | tojson }};
    document.querySelectorAll(".level-pill").forEach(pill => {
        const id = parseInt(pill.dataset.levelId);
        if(selectedLevels.includes(id)) pill.classList.add("selected");
    });

    // Click handler
    document.querySelectorAll(".level-pill").forEach(pill => {
        pill.addEventListener("click", function() {
            pill.classList.toggle("selected");
            sendLevelsAjax();
        });
    });
});

function sendLevelsAjax() {
    const selected = Array.from(document.querySelectorAll(".level-pill.selected"))
                          .map(p => p.dataset.levelId);

    fetch("{{ url_for('update_view') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            levels: selected,
            current_view: window.currentView || "table"
        })
    })
    .then(res => res.json())
    .then(data => {
        // Update the word table/cards/flashcards
        document.getElementById("words-container").innerHTML = data.html;

        // Reinitialize selected pills to match server state
        document.querySelectorAll(".level-pill").forEach(pill => {
            const id = parseInt(pill.dataset.levelId);
            pill.classList.toggle("selected", data.selected_levels.includes(id));
        });
    });
}
</script>
