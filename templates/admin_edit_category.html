{% extends "base.html" %}

{% block content %}




<h2>Edit Category: {{ category['name'] }}</h2>

<div class="admin-add-word-container">

    <!-- ‚úèÔ∏è Edit Category Info -->
    <form method="POST"
          action="{{ url_for('admin_edit_category', category_id=category['id']) }}"
          class="admin-add-word-form">
        <input type="hidden" name="action" value="update_category">

        <p>
            <label>Category Name:</label><br>
            <input type="text"
                   name="name"
                   value="{{ category['name'] }}"
                   required
                   class="admin-input">
        </p>

        <!-- Current parent + autocomplete to change parent -->
        <p>
            <label>Current Parent:</label><br>
            {% if parent_category %}
                <a href="{{ url_for('admin_edit_category', category_id=parent_category.id) }}#top"
                   class="admin-btn-small">
                    {{ parent_category.name }}
                </a>
            {% else %}
                <em>No parent (top-level category)</em>
            {% endif %}
        </p>

        <p>
            <label>Change Parent Category</label><br>
            <input type="text"
                   id="categoryInput"
                   autocomplete="off"
                   placeholder="Type to search‚Ä¶"
                   value="{{ parent_category.name if parent_category else '' }}">
            <input type="hidden"
                   name="parent_id"
                   id="categoryId"
                   value="{{ parent_category.id if parent_category else '' }}">

            <div id="suggestions" class="autocomplete-list"></div>
        </p>

        <p>
            <button type="submit" class="admin-btn">Update Category</button>
        </p>
    </form>

    <p>
        <a href="{{ url_for('admin_dashboard') }}" class="admin-btn-small">Back to Dashboard</a>
    </p>

    <hr>

    <!-- üå≥ Subcategories of this category -->
    <h3>Subcategories of this Category</h3>

    {% if subcategories %}
        <div class="admin-subcat-list">
            {% for sc in subcategories %}
                <p>
                    <a href="{{ url_for('admin_edit_category', category_id=sc.id) }}#top"
                       class="admin-btn-small">
                        {{ sc.name }}
                    </a>
                </p>
            {% endfor %}
        </div>
    {% else %}
        <p><em>No subcategories for this category.</em></p>
    {% endif %}

    <hr>

    <!-- üìã Words in Category -->
    <h3 id="words-section">Words in this Category</h3>

    {% if category_words %}
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Word</th>
                    <th>Edit</th>
                    <th>Remove</th>
                </tr>
            </thead>

            <tbody>
            {% for w in category_words %}
            <tr>
            <td>
                <a href="{{ url_for('show_word', word_name=w['word']) }}"
                target="_blank">{{ w['word'] }}</a>
            </td>

            <!-- ‚≠ê NEW: Edit column -->
            <td>
                <a href="{{ url_for('admin_edit_word', word_id=w['id']) }}"
                class="admin-btn-small">
                    Edit
                </a>
            </td>

            <td>
                <form method="POST"
                    action="{{ url_for('admin_remove_word_from_category', category_id=category['id'], word_id=w['id']) }}"
                    style="display:inline;"
                    onsubmit="return confirm('Are you sure you want to remove this word?');">
                    <button type="submit" class="admin-btn-small delete-btn">Remove</button>
                </form>
            </td>
        </tr>

            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p><em>No words yet in this category.</em></p>
    {% endif %}

    <hr>

    <a href="{{ url_for('admin_category_meanings', category_id=category['id']) }}"
       class="admin-btn-small">
        View / Edit Main Meanings
    </a>

    <hr>

    <!-- üîç Add Existing Word -->
    <h3 id="add-existing-word">Add Existing Word</h3>
    <form method="GET"
          action="{{ url_for('admin_edit_category', category_id=category['id']) }}#add-existing-word"
          class="admin-add-word-form"
          id="word-search-form"
          autocomplete="off">
        <p>
            <input type="text"
                   name="word_query"
                   id="word_query_input"
                   class="admin-input"
                   placeholder="Search for a word..."
                   value="{{ search_query }}"
                   autocomplete="off"
                   autocorrect="off"
                   autocapitalize="off"
                   spellcheck="false">
            <button type="submit" class="admin-btn">Search</button>
        </p>

        <!-- üîç Autocomplete suggestions for words -->
        <div id="word-suggestions" class="autocomplete-list"></div>
    </form>

    {% if search_results %}
        <ul>
        {% for w in search_results %}
            <li>
                <a href="{{ url_for('show_word', word_name=w['word']) }}"
                   target="_blank">{{ w['word'] }}</a>
            </li>
        {% endfor %}
        </ul>

        <form method="POST"
              action="{{ url_for('admin_edit_category', category_id=category['id']) }}#add-existing-word"
              class="admin-add-word-form">
            <input type="hidden" name="action" value="add_existing">
            <p>
                <label>Select a word to add:</label><br>
                <select name="existing_word_id" class="admin-select" required>
                    {% for w in search_results %}
                        <option value="{{ w['id'] }}">{{ w['word'] }}</option>
                    {% endfor %}
                </select>
            </p>
            <p>
                <button type="submit" class="admin-btn">Add Word to Category</button>
            </p>
        </form>
    {% elif search_query %}
        <p><em>No results found for ‚Äú{{ search_query }}‚Äù.</em></p>
    {% endif %}

    <hr>

    <!-- üÜï Add New Word to this Category -->
    <h3>Add New Word to this Category</h3>
    <form method="POST"
          action="{{ url_for('admin_edit_category', category_id=category['id']) }}#add-new-word"
          class="admin-add-word-form"
          id="add-new-word">
        <input type="hidden" name="action" value="add_new_word">

        <p>
            <label>Word:</label><br>
            <input type="text" name="new_word" required class="admin-input">
        </p>

        <!-- Level -->
        <p>
            <label>Level:</label><br>
            <select name="level" class="admin-select">
                {% for level in levels %}
                    <option value="{{ level.id }}">{{ level.name }}</option>
                {% endfor %}
            </select>
        </p>

        <hr>
        <p>Meanings</p>

        <div id="meanings-container" class="meanings-section">
            <!-- First meaning block -->
            <div class="meaning-block" data-meaning-number="1">
                <input type="hidden" name="meaning_number[]" value="1">

                <p>Part of Speech:</p>
                <select name="pos_id_1" required class="admin-select">
                    {% for pos in pos_list %}
                        <option value="{{ pos['id'] }}">{{ pos['name'] }}</option>
                    {% endfor %}
                </select>

                <p>Translations:</p>
                <div id="translations-1" class="translations-group">
                    <input type="text"
                           name="translations_1[]"
                           class="admin-input"
                           placeholder="Enter translation">
                </div>
                <button type="button"
                        class="admin-btn"
                        onclick="addTranslation(1)">+ Add Translation</button>

                <p>Examples:</p>
                <div id="examples-1" class="examples-group">
                    <div class="example-pair">
                        <input type="text"
                               name="examples_1[]"
                               class="admin-input"
                               placeholder="Enter example">
                        <input type="text"
                               name="examples_trans_1[]"
                               class="admin-input"
                               placeholder="Enter example translation">
                    </div>
                </div>
                <button type="button"
                        class="admin-btn"
                        onclick="addExample(1)">+ Add Example</button>

                <p>Definition (optional):</p>
                <input type="text"
                       name="definition_1"
                       class="admin-input"
                       placeholder="Enter definition">

                <p>Notes:</p>
                <input type="text"
                       name="meaning_notes[]"
                       class="admin-input"
                       placeholder="Enter notes">
            </div>
        </div>

        <button type="button"
                onclick="addMeaning()"
                class="admin-btn">+ Add Meaning</button>

        <p>
            <button type="submit" class="admin-btn">Add Word</button>
        </p>
    </form>
</div>

<form method="POST"
      action="{{ url_for('admin_delete_category', category_id=category['id']) }}"
      onsubmit="return confirm('Are you sure you want to delete this category? This cannot be undone.');">
    <button type="submit" class="admin-btn delete-btn">Delete Category</button>
</form>

<p>
    <a href="{{ url_for('admin_dashboard') }}" class="admin-btn-small">Back to Dashboard</a>
</p>

<script>
(function(){
    let meaningCount = 1;

    function addTranslation(num) {
        const container = document.getElementById(`translations-${num}`);
        const wrapper = document.createElement('div');
        wrapper.className = 'translation-item';
        const input = document.createElement('input');
        input.type = 'text';
        input.name = `translations_${num}[]`;
        input.className = 'admin-input';
        input.placeholder = 'Translation';
        wrapper.appendChild(input);
        container.appendChild(wrapper);
    }

    function addExample(num) {
        const container = document.getElementById(`examples-${num}`);
        const wrapper = document.createElement('div');
        wrapper.className = 'example-pair';
        const text = document.createElement('input');
        text.type = 'text';
        text.name = `examples_${num}[]`;
        text.className = 'admin-input';
        text.placeholder = 'Example';
        const trans = document.createElement('input');
        trans.type = 'text';
        trans.name = `examples_trans_${num}[]`;
        trans.className = 'admin-input';
        trans.placeholder = 'Translation';
        wrapper.appendChild(text);
        wrapper.appendChild(trans);
        container.appendChild(wrapper);
    }

    window.addMeaning = function() {
        meaningCount++;
        const container = document.getElementById('meanings-container');
        const div = document.createElement('div');
        div.className = 'meaning-block';
        div.dataset.meaningNumber = meaningCount;
        div.innerHTML = `
            <input type="hidden" name="meaning_number[]" value="${meaningCount}">

            <p>Part of Speech:</p>
            <select name="pos_id_${meaningCount}" required class="admin-select">
                {% for pos in pos_list %}
                <option value="{{ pos['id'] }}">{{ pos['name'] }}</option>
                {% endfor %}
            </select>

            <p>Translations:</p>
            <div id="translations-${meaningCount}" class="translations-group">
                <input type="text"
                       name="translations_${meaningCount}[]"
                       class="admin-input"
                       placeholder="Enter translation">
            </div>
            <button type="button"
                    class="admin-btn"
                    onclick="addTranslation(${meaningCount})">+ Add Translation</button>

            <p>Examples:</p>
            <div id="examples-${meaningCount}" class="examples-group">
                <div class="example-pair">
                    <input type="text"
                           name="examples_${meaningCount}[]"
                           class="admin-input"
                           placeholder="Enter example">
                    <input type="text"
                           name="examples_trans_${meaningCount}[]"
                           class="admin-input"
                           placeholder="Enter example translation">
                </div>
            </div>
            <button type="button"
                    class="admin-btn"
                    onclick="addExample(${meaningCount})">+ Add Example</button>

            <p>Definition (optional):</p>
            <input type="text"
                   name="definition_${meaningCount}"
                   class="admin-input"
                   placeholder="Enter definition">

            <p>Notes:</p>
            <input type="text"
                   name="meaning_notes[]"
                   class="admin-input"
                   placeholder="Enter notes">
        `;
        container.appendChild(div);
    };

    window.addTranslation = addTranslation;
    window.addExample = addExample;
})();
</script>

<script>
// ===== Parent category autocomplete =====
const categories = [
    {% for c in all_categories %}
        { id: {{ c.id }}, name: {{ c.name|tojson }} },
    {% endfor %}
];

const input = document.getElementById("categoryInput");
const idField = document.getElementById("categoryId");
const list = document.getElementById("suggestions");

function showCategorySuggestions(value) {
    list.innerHTML = "";
    list.style.display = "block";

    const filtered = categories.filter(c =>
        value === "" || c.name.toLowerCase().startsWith(value.toLowerCase())
    );

    if (filtered.length === 0) {
        const item = document.createElement("div");
        item.className = "autocomplete-item empty";
        item.textContent = "No matches";
        list.appendChild(item);
        return;
    }

    filtered.forEach(cat => {
        const item = document.createElement("div");
        item.className = "autocomplete-item";
        item.textContent = cat.name;

        item.addEventListener("mousedown", (e) => {
            e.preventDefault();
            e.stopPropagation();
            input.value = cat.name;
            idField.value = cat.id;
            list.style.display = "none";
        });

        list.appendChild(item);
    });
}

if (input) {
    input.addEventListener("input", () => {
        if (input.value.trim() === "") {
            idField.value = "";
        }
        showCategorySuggestions(input.value);
    });

    input.addEventListener("focus", () => {
        showCategorySuggestions(input.value);
    });

    document.addEventListener("click", (e) => {
        if (!list.contains(e.target) && e.target !== input) {
            list.style.display = "none";
        }
    });
}
</script>

<script>
// ===== Word search autocomplete =====
const allWords = [
    {% for w in all_words %}
        { id: {{ w.id }}, word: {{ w.word|tojson }} },
    {% endfor %}
];

const wordInput = document.getElementById("word_query_input");
const wordSuggestions = document.getElementById("word-suggestions");
const wordSearchForm = document.getElementById("word-search-form");

function showWordSuggestions(value) {
    wordSuggestions.innerHTML = "";

    const trimmed = value.trim();
    if (!trimmed) {
        wordSuggestions.style.display = "none";
        return;
    }

    wordSuggestions.style.display = "block";

    const lower = trimmed.toLowerCase();
    const filtered = allWords
        .filter(w => w.word.toLowerCase().startsWith(lower))
        .slice(0, 15);

    if (filtered.length === 0) {
        const item = document.createElement("div");
        item.className = "autocomplete-item empty";
        item.textContent = "No matches";
        wordSuggestions.appendChild(item);
        return;
    }

    filtered.forEach(w => {
        const item = document.createElement("div");
        item.className = "autocomplete-item";
        item.textContent = w.word;

        // mousedown so blur doesn't kill us first; auto-submit to skip pressing Search
        item.addEventListener("mousedown", (e) => {
            e.preventDefault();
            e.stopPropagation();
            wordInput.value = w.word;
            wordSuggestions.style.display = "none";
            if (wordSearchForm) {
                wordSearchForm.submit();   // üîÅ reload to same page + #add-existing-word
            }
        });

        wordSuggestions.appendChild(item);
    });
}

if (wordInput) {
    wordInput.addEventListener("input", () => {
        showWordSuggestions(wordInput.value);
    });

    wordInput.addEventListener("focus", () => {
        if (wordInput.value.trim() !== "") {
            showWordSuggestions(wordInput.value);
        }
    });

    document.addEventListener("click", (e) => {
        if (!wordSuggestions.contains(e.target) && e.target !== wordInput) {
            wordSuggestions.style.display = "none";
        }
    });
}
</script>

{% endblock %}
