{% extends "base.html" %}
{% block content %}


{% if meanings_by_pos is none %}
    <p>Word not found.</p>
{% else %}

    {# ---- Word header with level badge ---- #}
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
        <h1 style="margin:0;">
            {{ word_name }}
        </h1>
        {% if word_level_id and word_level_id != 0 %}
            <span class="level-badge level-{{ word_level_id }}">
                {{ word_level_name }}
            </span>
        {% endif %}
    </div>

    {# ---- Topics (categories) as pills under the word ---- #}
    {% if categories %}
    <div class="categories" style="margin-top:8px;">
        <strong>Topics:</strong>
        {% for cat in categories %}
            <a href="{{ url_for('show_category', category_name=cat) }}"
               class="category-pill">
                {{ cat }}
            </a>
        {% endfor %}
    </div>
    {% endif %}

    {# ---- Meanings grouped by part of speech ---- #}
    {% for pos_name, meanings in meanings_by_pos.items() %}
        <div class="meaning" style="margin-top:1.5em;">

            {# POS label #}
            <div style="
                display:inline-block;
                margin-bottom:0.4em;
                padding:2px 8px;
                border-radius:999px;
                font-size:0.85rem;
                background:#eef2ff;
                color:#1a237e;">
                {{ pos_name }}
            </div>

            {% for meaning in meanings %}
            <div class="meaning-block">

                {# Translation line with global numbering #}
                <p style="margin:0 0 0.4em 0;">
                    <strong>{{ meaning.display_number }}.</strong>
                    <span class="translation">
                        {{ meaning.translations | join(", ") }}
                    </span>
                </p>

                {# ---- DETAILS BUTTON ---- #}
                {% if meaning.definition or meaning.notes %}
                    <button type="button" class="expand-btn"
                            data-label-show="Show details"
                            data-label-hide="Hide details"
                            style="margin-top:6px;"
                            onclick="return toggleExpand(this);">
                        <span class="chevron">▶</span>
                        <span class="label">Show details</span>
                    </button>
                    <div class="expand-content"
                         style="display:none; margin-top:6px; margin-left:4px;">
                        {% if meaning.definition %}
                            <p><strong>Definition:</strong> {{ meaning.definition }}</p>
                        {% endif %}
                        {% if meaning.notes %}
                            <p><strong>Notes:</strong> {{ meaning.notes }}</p>
                        {% endif %}
                    </div>
                {% endif %}

                {# ---- EXAMPLES BUTTON ---- #}
                {% if meaning.examples %}
                    <button type="button" class="expand-btn"
                            data-label-show="Show examples"
                            data-label-hide="Hide examples"
                            style="margin-top:6px;"
                            onclick="return toggleExpand(this);">
                        <span class="chevron">▶</span>
                        <span class="label">Show examples</span>
                    </button>
                    <div class="expand-content"
                         style="display:none; margin-top:6px; margin-left:4px;">
                        {% for ex in meaning.examples %}
                            <p style="margin-bottom:0.6em;">
                                {{ ex.text }}
                                {% if ex.translation %}
                                    <br><em>{{ ex.translation }}</em>
                                {% endif %}
                            </p>
                        {% endfor %}
                    </div>
                {% endif %}

                {# ---- MEANING-LEVEL RELATIONS (this sense) ---- #}
                {% if meaning_relations.get(meaning.id) %}
                    <button type="button" class="expand-btn"
                            data-label-show="Show relations"
                            data-label-hide="Hide relations"
                            style="margin-top:6px;"
                            onclick="return toggleExpand(this);">
                        <span class="chevron">▶</span>
                        <span class="label">Show relations</span>
                    </button>
                    <div class="expand-content"
                        style="display:none; margin-top:6px; margin-left:4px;">

                        {% set mrels = meaning_relations[meaning.id] %}

                        {# Optional special case: same root for this sense #}
                        {% if mrels.get('same root') %}
                        <div class="relation-block">
                            <div class="relation-type-label">Word family (this sense):</div>
                            <div class="relation-chips">
                                {% for t in mrels['same root'] %}
                                    {% set tr_list = t.translations or [] %}
                                    {% set shown_tr = tr_list[:2] %}
                                    <a href="{{ url_for('show_word', word_name=t.target_word) }}"
                                       class="relation-chip">
                                        {{ t.target_word }}
                                        {% if shown_tr %}
                                            ({{ shown_tr | join(", ") }})
                                        {% endif %}
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {# Other relation types for this meaning #}
                        {% for rt, targets in mrels.items() %}
                            {% if rt != 'same root' %}
                            <div class="relation-block">
                                <div class="relation-type-label">{{ rt }}:</div>
                                <div class="relation-chips">
                                    {% for t in targets %}
                                        {% set tr_list = t.translations or [] %}
                                        {% set shown_tr = tr_list[:2] %}
                                        <a href="{{ url_for('show_word', word_name=t.target_word) }}"
                                           class="relation-chip">
                                            {{ t.target_word }}
                                            {% if shown_tr %}
                                                ({{ shown_tr | join(", ") }})
                                            {% endif %}
                                        </a>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}

                    </div>
                {% endif %}

            </div>  {# /.meaning-block #}
            {% endfor %}

        </div>  {# /.meaning (POS group) #}
    {% endfor %}

    {# ---- WORD-LEVEL RELATIONS (global for this word) ---- #}
    {% if word_relations %}
    <div style="margin-top:1.8em;">
        <button type="button" class="expand-btn"
                data-label-show="Show related words"
                data-label-hide="Hide related words"
                onclick="return toggleExpand(this);">
            <span class="chevron">▶</span>
            <span class="label">Show related words</span>
        </button>

        <div class="expand-content" style="display:none; margin-top:6px;">

            {# Special handling: word family at word level #}
            {% if word_relations.get('same root') %}
            <div class="relation-block">
                <div class="relation-type-label">Word family:</div>
                <div class="relation-chips">
                    {% for t in word_relations['same root'] %}
                        <a href="{{ url_for('show_word', word_name=t.target_word) }}"
                           class="relation-chip"
                           title="{{ t.target_word }}">
                            {{ t.target_word }}
                        </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Other relation types (synonyms, antonyms, etc.) #}
            {% for rt, targets in word_relations.items() %}
                {% if rt != 'same root' %}
                <div class="relation-block">
                    <div class="relation-type-label">{{ rt }}:</div>
                    <div class="relation-chips">
                        {% for t in targets %}
                            <a href="{{ url_for('show_word', word_name=t.target_word) }}"
                               class="relation-chip"
                               title="{{ t.target_word }}">
                                {{ t.target_word }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}

        </div>
    </div>
    {% endif %}

{% endif %}


{% if collocations %}
<div style="margin-top:2em;">

    {# Local-only link styling (scoped to this block) #}
    <style>
        .colloc-block a.colloc-link {
            color: inherit;
            text-decoration: none;
        }
        .colloc-block a.colloc-link:hover {
            color: #0d6efd;
            text-decoration: underline;
        }
    </style>

    <button type="button" class="expand-btn"
            data-label-show="Show common phrases"
            data-label-hide="Hide common phrases"
            onclick="return toggleExpand(this);">
        <span class="chevron">▶</span>
        <span class="label">Show common phrases</span>
    </button>

    <div class="expand-content colloc-block" style="display:none; margin-top:8px;">

        <div style="margin-top:0.5em;">
            {% for c in collocations %}
                <div style="margin-bottom:0.8em; padding:6px 8px; border-left:3px solid #ddd;">

                  {# --- Main collocation phrase --- #}
                <div>
                    {# Only link if the other word exists in DB (robust even if key missing) #}
                    {% set can_link = (c.other_word_id|default(0)|int > 0) %}

                    {# Link target = lemma if you have it, otherwise other_form #}
                    {% set link_target = c.other_lemma if c.other_lemma else c.other_form %}

                    {% if c.surface_form %}
                        {% set toks = c.surface_form.split() %}

                        {% if toks|length <= 1 %}
                            <strong>{{ c.surface_form }}</strong>
                        {% else %}
                            {% if c.direction == 'L' %}
                                {# other word is the LEFT token #}
                                <strong>
                                    {% if can_link and link_target -%}
                                        <a class="colloc-link" href="{{ url_for('show_word', word_name=link_target) }}">{{ toks[0] }}</a>
                                    {%- else -%}
                                        {{ toks[0] }}
                                    {%- endif -%}
                                    {{ ' ' ~ toks[1:]|join(' ') }}
                                </strong>
                            {% else %}
                                {# other word is the RIGHT token #}
                                <strong>
                                    {{ toks[:-1]|join(' ') ~ ' ' -}}
                                    {% if can_link and link_target -%}
                                        <a class="colloc-link" href="{{ url_for('show_word', word_name=link_target) }}">{{ toks[-1] }}</a>
                                    {%- else -%}
                                        {{ toks[-1] }}
                                    {%- endif %}
                                </strong>
                            {% endif %}
                        {% endif %}

                    {% else %}
                        {# Fallback if surface_form is missing #}
                        <strong>
                            {% if c.direction == 'L' %}
                                {% if can_link and link_target -%}
                                    <a class="colloc-link" href="{{ url_for('show_word', word_name=link_target) }}">{{ c.other_form }}</a>
                                {%- else -%}
                                    {{ c.other_form }}
                                {%- endif -%}
                                {{ ' ' ~ word_name }}
                            {% else %}
                                {{ word_name ~ ' ' -}}
                                {% if can_link and link_target -%}
                                    <a class="colloc-link" href="{{ url_for('show_word', word_name=link_target) }}">{{ c.other_form }}</a>
                                {%- else -%}
                                    {{ c.other_form }}
                                {%- endif %}
                            {% endif %}
                        </strong>
                    {% endif %}
                </div>

                    {# --- Collocation translation --- #}
                    {% if c.translation %}
                        <div style="font-size:1.0rem; margin-top:2px; color:#444;">
                            <em>{{ c.translation }}</em>
                        </div>
                    {% endif %}

                    {# --- Example sentence --- #}
                    {% if c.example_text %}
                        <div style="font-size:0.9rem; margin-top:3px;">
                            {{ c.example_text }}
                            {% if c.example_translation %}
                                <br>
                                <em>{{ c.example_translation }}</em>
                            {% endif %}
                        </div>
                    {% endif %}

                </div>
            {% endfor %}
        </div>

    </div>
</div>
{% endif %}




{# ---- EXPAND TOGGLE JS (shared for all buttons) ---- #}
<script>
function toggleExpand(btn) {
    try {
        // Find the corresponding content block
        let content = btn.nextElementSibling;

        if (!content || !content.classList.contains('expand-content')) {
            let sibling = btn.nextSibling;
            content = null;

            while (sibling) {
                if (sibling.nodeType === 1 && sibling.classList.contains('expand-content')) {
                    content = sibling;
                    break;
                }
                sibling = sibling.nextSibling;
            }
        }

        if (!content) {
            return false;
        }

        // Determine current visibility
        const style = window.getComputedStyle(content);
        const currentlyHidden = (style.display === 'none' || style.display === '');

        // Toggle display
        content.style.display = currentlyHidden ? 'block' : 'none';

        // Update button state / label
        btn.classList.toggle('expanded', currentlyHidden);

        const labelSpan = btn.querySelector('.label');
        if (labelSpan) {
            const showText = btn.dataset.labelShow || 'Show';
            const hideText = btn.dataset.labelHide || 'Hide';
            labelSpan.textContent = currentlyHidden ? hideText : showText;
        }
    } catch (e) {
        // Fail silently in production
        console && console.error && console.error('toggleExpand error', e);
    }
    return false; // prevent any default action
}
</script>

{% endblock %}
